<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>4. Writing your own Functions</title><link rel="stylesheet" type="text/css" href="docbook-xsl.css" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="Tridash Tutorials" /><link rel="up" href="index.html" title="Tridash Tutorials" /><link rel="prev" href="ar01s03.html" title="3. Conditional Bindings" /><link rel="next" href="ar01s05.html" title="5. Error Handling" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><td width="20%" align="left"><a accesskey="p" href="ar01s03.html"><img src="images/icons/prev.png" alt="Prev" /></a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="ar01s05.html"><img src="images/icons/next.png" alt="Next" /></a></td></tr></table><hr /></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="tutorial4"></a>4. Writing your own Functions</h2></div></div></div><p>In this tutorial you’ll learn how to create your own functions, which
can be used in functional bindings. Another feature which distinguishes
Tridash from frameworks/toolkits, which offer bindings, is that new
functions can be written in the same language, as the language in
which the bindings are declared, rather than having to be implemented
in a lower-level language.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_definition_operator"></a>4.1. Definition Operator</h3></div></div></div><p>New functions, referred to as meta-nodes, are defined using the
special <code class="literal">:</code> operator, which has the following syntax:</p><pre class="screen">function(arg1, arg2, ...) : {
   declarations...
}</pre><p>The left-hand side contains the function name (<code class="literal">function</code>) followed by
the argument list in brackets, where each item (<code class="literal">arg1</code>, <code class="literal">arg2</code>, …)
is the name of the local node to which the argument at that position
is bound.</p><p>The right-hand side, of the <code class="literal">:</code> operator, contains the declarations
making up the body of the function, which may consist of any Tridash
node declaration.</p><p>Nodes created within the body of a meta-node are local to the
meta-node, meaning they can only be referenced from within it even if
the same node identifier occurs in an expression in the global
scope. Local nodes are created for each of the arguments, and for
nodes which appear as the target of a binding. Node expressions which
appear in source position primarily reference local nodes, however if
no local node is found, the enclosing scope of the meta-node is
searched. This differs from global node expressions, in which nodes
are automatically created if no node with that identifier exists.</p><p>Meta-nodes return the value of the last node in the <code class="literal">declarations</code>
list comprising the body. The curly braces <code class="literal">{</code> and <code class="literal">}</code> are optional if
the meta-node body consists of a single declaration.</p><p>Alternatively an explicit binding to the <code class="literal">self</code> node, can be
established. In that case, the return value of the meta-node, is the
value of the <code class="literal">self</code> node, rather than the last node in the body.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_examples"></a>Examples</h4></div></div></div><pre class="screen"># Add two numbers <a id="CO1-1"></a><span><img src="images/icons/callouts/1.png" alt="1" border="0" /></span>

add(x, y) : x + y</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO1-1"><span><img src="images/icons/callouts/1.png" alt="1" border="0" /></span></a> </p></td><td valign="top" align="left"><p>
This is a comment. Comments begin with a <code class="literal">#</code> character and extend
till the end of the line. All content within a comment is discarded.
</p></td></tr></table></div><p>In the example, above, a meta-node <code class="literal">add</code> is defined which takes two
arguments, bound to the local nodes <code class="literal">x</code> and <code class="literal">y</code>. The function body
consists of a single node declaration, hence the curly braces were
omitted, <code class="literal">x + y</code> which is a functor node that computes the sum of <code class="literal">x</code>
and <code class="literal">y</code>. The meta-node returns the value of <code class="literal">x + y</code> since it is the
last node in the body.</p><p>The following example demonstrates recursive meta-nodes:</p><pre class="screen"># Computes the factorial of n

factorial(n) : {
  case(
    n &gt; 1 : n * factorial(n - 1),
    1
  )
}</pre><p>The following example demonstrates that meta-nodes may themselves
contain nested meta-nodes, which are local to the meta-node and can
only be referenced within it.</p><pre class="screen"># Tail recursive factorial

factorial(n) : {
  iter(n, acc) : {
    case(
      n &gt; 1 : iter(n - 1, n * acc),
      acc
    )
  }

  iter(n, 1)
}</pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_budget_meter"></a>4.2. Budget Meter</h3></div></div></div><p>Our current application displays some nice visual indications, in the
form of color, which allow us to see, at a glance, whether the budget
has been exceeded. However the visual indications are still quite
limited, giving only a binary indication of whether the budget was
exceeded or not. It would be nice if there is also a visual indication
of how close the total is to the budget.</p><p>In this tutorial we’ll enhance the budget application by displaying a
meter, which directly indicates how close the total is to the
budget. Additionally we’d also like the meter to be displayed in a
color that is between green and red proportional to how much the total
is between zero and the budget.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_color_interpolation"></a>Color Interpolation</h4></div></div></div><p>Let’s first begin with computing the color of the meter. Our goal is
to linearly interpolate a color between green and red depending on
where the total amount allocated lies between zero and the
budget. This is where meta-nodes will come in handy.</p><p>We’ll start off by writing a linear interpolation meta-node <code class="literal">lerp</code>.</p><pre class="screen">lerp(a, b, alpha) : lo + alpha * (b - a)</pre><p>The value returned by the meta-node is the fractional value, at the
fraction <code class="literal">alpha</code>, between <code class="literal">a</code> and <code class="literal">b</code>.</p><p>Let’s write another handy meta-node for creating a CSS <code class="literal">hsl</code> color
string out of hue, saturation and luminance components.</p><div class="tip" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/tip.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>Interpolation is done in the HSL color space, rather than the RGB
color space as it provides better results.</p></td></tr></table></div><pre class="screen">make-hsl(h, s, l) :
    format("hsl(%s,%s%%,%s%%)", h, s, l)</pre><div class="tip" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/tip.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>The <code class="literal">format</code> meta-node takes a format string, followed by a
variable number of arguments, and returns the format string with all
<code class="literal">%s</code> placeholders replaced by the arguments. <code class="literal">%%</code> is replaced with a
literal <code class="literal">%</code> character.</p></td></tr></table></div><p>The next step is to compute the interpolation coefficient <code class="literal">alpha</code>
based on where the total sum lies between zero and the budget.</p><p>To make sure that the interpolation coefficient is between 0 and 1,
we’ll write a <code class="literal">clamp</code> meta-node, for clamping a value to a given
range:</p><pre class="screen">clamp(x, min, max) :
   case (
      x &lt; min : min,
      x &gt; max : max,
      x
   )</pre><p>Using the <code class="literal">clamp</code> meta-node, we compute the <code class="literal">alpha</code> coefficient
clamped to the range [0, 1]:</p><pre class="screen">clamp((total + 1) / (budget + 1), 0, 1) -&gt; scale</pre><div class="note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/note.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p><code class="literal">1</code> was added to the total and budget to prevent division by
zero in the case that <code class="literal">budget</code> is equal to <code class="literal">0</code>. This obviously does
not work if <code class="literal">budget</code> is equal to <code class="literal">-1</code> however this will be handled in
the following tutorials.</p></td></tr></table></div><p>And now finally we’ll compute the color making use of the <code class="literal">lerp</code>
meta-node we implemented earlier:</p><pre class="screen">make-hsl(
   lerp(120, 0, scale),
   90,
   45
) -&gt; meter-color</pre><p>The hue is linearly interpolated between <span class="green">green</span> <code class="literal">120</code> and
<span class="red">red</span> <code class="literal">0</code>, depending on where the total lies between <code class="literal">0</code> and the
<code class="literal">budget</code>.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_creating_the_meter"></a>Creating the Meter</h4></div></div></div><p>Now we’ll actually create the meter. We need two block elements, one
which displays a border containing the meter and another element which
displays the portion of the meter that is filled.</p><p>Add the following HTML elements below the “Total” field.</p><pre class="programlisting">&lt;div class="meter-box"&gt;
  &lt;div id="meter" class="meter-bar"&gt;&lt;/div&gt;
&lt;/div&gt;</pre><p>Add the following <code class="literal">style</code> tag, which contains the style attributes of
the <code class="literal">meter-box</code> and <code class="literal">meter-bar</code> classes, within the <code class="literal">&lt;head&gt;...&lt;/head&gt;</code>
tag:</p><pre class="programlisting">&lt;style&gt;
 .meter-box {
     margin-top: 5px;
     width: 200px;
     height: 1em;
     border: 1px solid black;
  }
 .meter-bar {
     height: 100%;
 }
&lt;/style&gt;</pre><p>The <code class="literal">meter-box</code> class, applied to the block element which serve as the
container, gives the element a width, height and a border. The
<code class="literal">meter-bar</code> class, applied to the element which displays the filled
portion, specifies that the filled portion should take up <code class="literal">100%</code> of
the vertical space within the container.</p><p>The meter should be filled proportionally to how close the value of
<code class="literal">total</code> is to the value of <code class="literal">budget</code>. The proportion is already given
by the value of the <code class="literal">scale</code> node. To implement the <span class="emphasis"><em>filling</em></span> of the
meter, we simply need to bind the <code class="literal">scale</code> node to the <code class="literal">width</code> style
attribute of the <code class="literal">meter</code> element.</p><p>This is achieved with the following:</p><pre class="screen">format("%s%%", scale * 100) -&gt; self.meter.style.width</pre><p>The <code class="literal">scale</code> is multiplied by <code class="literal">100</code> to convert it to a percentage, and
<code class="literal">format</code> is used to convert the numeric value to a string with a <code class="literal">%</code>
appended to it. This specifies that the width of the meter should be a
percentage, given by <code class="literal">scale</code>, of the width of its parent container.</p><p>Finally we need to bind <code class="literal">meter-color</code>, which stores the interpolated
color, to the background color of the meter.</p><pre class="screen">meter-color -&gt; self.meter.style.backgroundColor</pre><p>This is the full code that needs to be added to the Tridash code tag,
to implement the meter:</p><pre class="screen">lerp(a, b, alpha) : a + alpha * (b - a)

clamp(x, min, max) :
    case (
        x &lt; min : min,
        x &gt; max : max,
        x
    )

make-hsl(h, s, l) :
    format("hsl(%s,%s%%,%s%%)", h, s, l)

clamp((total + 1) / (budget + 1), 0, 1) -&gt; scale

make-hsl(
    lerp(120, 0, scale),
    90,
    45
) -&gt; meter-color

format("%s%%", scale * 100) -&gt; self.meter.style.width
meter-color -&gt; self.meter.style.backgroundColor</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_let_8217_s_try_it_out_3"></a>Let’s try it out</h4></div></div></div><p>Build the application and open the resulting <code class="literal">app.html</code> file in a web
browser.</p><p>Enter some initial values for the budget and expense totals. Start off
with low expense totals such that the total expenses are well within
the budget:</p><div class="informalfigure"><div class="mediaobject" align="center"><img src="images/tutorial4/snap1.png" align="middle" alt="Snapshot: Budget 100, Total 30. Meter 1/3 filled, displayed in bright green." /></div></div><p>The filled portion is roughly a third of the meter and is displayed in
a bright green.</p><p>Now start increasing the expenses to bring the total closer to the
budget:</p><div class="informalfigure"><div class="mediaobject" align="center"><img src="images/tutorial4/snap2.png" align="middle" alt="Snapshot: Total 50. Meter half filled, displayed in yellow." /></div></div><div class="informalfigure"><div class="mediaobject" align="center"><img src="images/tutorial4/snap3.png" align="middle" alt="Snapshot: Total 70. Meter more than half filled, displayed in orange." /></div></div><p>The meter gradually fills up and starts changing to red the closer the
total expenses are to the budget.</p><p>Now finally increase the expenses till the total exceeds the budget:</p><div class="informalfigure"><div class="mediaobject" align="center"><img src="images/tutorial4/snap4.png" align="middle" alt="Snapshot: Total, 120. Meter filled, displayed in bright red." /></div></div><p>The mete is fully filled and displayed in a bright red color.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_summary_3"></a>4.3. Summary</h3></div></div></div><p>In this tutorial you learned how to create your own functions,
referred to as meta-nodes, which can be used in functor node
expressions.</p><div class="tip" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/tip.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>Functions are referred to as meta-nodes since they are nodes,
themselves, which describe how the values of other nodes, referred to
as meta-node instances, are computed, hence the term meta-nodes.</p></td></tr></table></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ar01s03.html"><img src="images/icons/prev.png" alt="Prev" /></a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="ar01s05.html"><img src="images/icons/next.png" alt="Next" /></a></td></tr><tr><td width="40%" align="left" valign="top"> </td><td width="20%" align="center"><a accesskey="h" href="index.html"><img src="images/icons/home.png" alt="Home" /></a></td><td width="40%" align="right" valign="top"> </td></tr></table></div></body></html>