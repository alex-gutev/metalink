<?
 :import(core)

 # Utility Meta-nodes

 lerp(a, b, alpha) : a + alpha * (b - a)

 clamp(x, min, max) :
     case (
         x < min : min,
         x > max : max,
         x
     )

 Color(h, s, l) : {
     h -> self.hue
     s -> self.saturation
     l -> self.luminance
 }

 lerp-color(c1, c2, alpha) : {
     Color(
         lerp(c1.hue, c2.hue, alpha),
         lerp(c1.saturation, c2.saturation, alpha),
         lerp(c1.luminance, c2.luminance, alpha)
     )
 }

 make-hsl(c) :
     format("hsl(%s,%s%%,%s%%)", c.hue, c.saturation, c.luminance)


 # Application Logic

 valid-amount(thing) : {
     x <- real(thing)
     x >= 0 -> x -> self
 }

 :attribute(valid-amount, target-node, valid-amount)


 compute-color(total, budget) : {
     clamp((total + 1) / (budget + 1), 0, 1) -> scale
     make-hsl(lerp-color(in-budget-color, out-budget-color, scale))
 }


 food + electricity + water -> total

 make-hsl(
     case(
         total < budget : in-budget-color,
         out-budget-color
     )
 ) -> color

 color -> self.total.style.backgroundColor
 color -> self.status.style.color

 "white" -> self.total.style.color


 clamp((total + 1) / (budget + 1), 0, 1) -> scale

 compute-color(total, budget) -> meter-color

 format("%s%%", scale * 100) -> self.meter.style.width
 meter-color -> self.meter.style.backgroundColor


 # Error Handling

 error-prompt(thing) : {
     error-message <- "Please enter a valid number \u{2265} 0!"
     if (fails?(thing), error-message, "")
 }

 # Initial Values

 0 -> budget
 0 -> food
 0 -> water
 0 -> electricity

 # Set initial value of in-budget-color to green
 Color(120, 90, 45) -> in-budget-color

 # Set initial value of out-budget-color to red
 Color(0, 90, 45) -> out-budget-color


 # Preferences

 make-hsl(in-budget-color) -> self.in-budget-preview.style.backgroundColor
 make-hsl(out-budget-color) -> self.out-budget-preview.style.backgroundColor

 :attribute(self.in-budget-hue.value, urgent, 1)
 :attribute(self.in-budget-saturation.value, urgent, 1)
 :attribute(self.in-budget-luminance.value, urgent, 1)

 :attribute(self.out-budget-hue.value, urgent, 1)
 :attribute(self.out-budget-saturation.value, urgent, 1)
 :attribute(self.out-budget-luminance.value, urgent, 1)

?>

<!doctype html>
<html>
    <head>
        <title>Budget App</title>
	<style>
	  .meter-box {
	      margin-top: 5px;
	      width: 200px;
	      height: 1em;
	      border: 1px solid black;
	  }
	  .meter-bar {
	      height: 100%;
	  }
	</style>
    </head>
    <body>
      <h1>Budget App</h1>
      <div>
	<label for="budget">Budget:</label>
	<div>
	  <input id="budget" value="<?@ valid-amount(budget) ?>"/>
	  <?@ error-prompt(budget) ?>
	</div>
      </div>
      <hr>
      <div>
	<label for="food">Food:</label>
	<div>
	  <input id="food" value="<?@ valid-amount(food) ?>" />
	  <?@ error-prompt(food) ?>
	</div>
      </div>
      <div>
	<label for="electricity">Electricity:</label>
	<div>
	  <input id="electricity" value="<?@ valid-amount(electricity) ?>" />
	  <?@ error-prompt(electricity) ?>
	</div>
      </div>
      <div>
	<label for="water">Water:</label>
	<div>
	  <input id="water" value="<?@ valid-amount(water) ?>" />
	  <?@ error-prompt(water) ?>
	</div>
      </div>
      <hr>
      <div>
	<label for="total"><strong>Total:</strong></label>
	<div>
	  <input id="total" value="<?@ total ?>" readonly/>
	  <span id="status">
            <?@
             case(
                 total < budget : "Within budget.",
                 "Budget exceeded!!!"
             )
             ?>
	  </span>
	</div>
      </div>
      <div class="meter-box">
	<div id="meter" class="meter-bar"></div>
      </div>

      <details style="margin-top: 5px">
        <summary>Preferences</summary>
        <strong>Within Budget Color: <div style="display: inline-block; width: 2em; height: 2em; vertical-align: middle" id="in-budget-preview"></div></strong>

        <div>
          <label for="in-budget-hue">Hue:</label>
	  <div>
	    <input id="in-budget-hue" type="range" min="0" max="360" value="<?@ to-int(in-budget-color.hue) ?>"/>
	  </div>

          <label for="in-budget-saturation">Saturation:</label>
	  <div>
	    <input id="in-budget-saturation" type="range" min="0" max="100" value="<?@ to-int(in-budget-color.saturation) ?>"/>
	  </div>
          <label for="in-budget-luminance">Luminance:</label>
	  <div>
	    <input id="in-budget-luminance" type="range" min="0" max="100" value="<?@ to-int(in-budget-color.luminance) ?>"/>
	  </div>
        </div>

        <strong>Budget Exceeded Color: <div style="display: inline-block; width: 2em; height: 2em; vertical-align: middle" id="out-budget-preview"></div></strong>
        <div>
          <label for="out-budget-hue">Hue:</label>
	  <div>
	    <input id="out-budget-hue" type="range" min="0" max="360" value="<?@ to-int(out-budget-color.hue) ?>"/>
	  </div>
          <label for="out-budget-saturation">Saturation:</label>
	  <div>
	    <input id="out-budget-saturation" type="range" min="0" max="100" value="<?@ to-int(out-budget-color.saturation) ?>"/>
	  </div>
          <label for="out-budget-luminance">Luminance:</label>
	  <div>
	    <input id="out-budget-luminance" type="range" min="0" max="100" value="<?@ to-int(out-budget-color.luminance) ?>"/>
	  </div>
        </div>
      </details>
    </body>
</html>
