## Path to compiler and tools

LISP = @LISP@
SED = @SED@
A2X = @A2X@

## Directories

prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@

datarootdir = @datarootdir@
datadir = @datadir@
mandir = @mandir@

pkgdatadir = @datadir@/@PACKAGE@


PACKAGE_TARNAME = @PACKAGE_TARNAME@
PACKAGE_VERSION = @PACKAGE_VERSION@

# Add source directory to search path for out of source builds

srcdir = @srcdir@
VPATH = $(srcdir)


## Build Targets

all: tridashc man js_runtime

plump_sources = plump/dom.lisp \
	plump/entities.lisp \
	plump/lexer.lisp \
	plump/package.lisp \
	plump/parser.lisp \
	plump/processing.lisp \
	plump/special-tags.lisp \
	plump/tag-dispatcher.lisp

sources = tridash.asd \
        src/package.lisp \
        src/interface.lisp \
        src/lexer.lisp \
        src/parser.lisp \
        src/operators.lisp \
        src/node.lisp \
        src/meta-node.lisp \
        src/module.lisp \
        src/module-table.lisp \
	src/builder-interface.lisp \
        src/conditions.lisp \
        src/outer-nodes.lisp \
	src/strictness.lisp \
        src/builder.lisp \
	src/macros.lisp \
        src/coalescer.lisp \
        src/prog-builder.lisp \
        src/main.lisp \
        src/util/package.lisp \
        src/util/cut.lisp \
        src/util/macros.lisp \
        src/builders/html/package.lisp \
        src/builders/html/builder.lisp \
	src/builders/html/script-parser.lisp \
        src/backends/javascript/package.lisp \
        src/backends/javascript/ast.lisp \
        src/backends/javascript/print.lisp \
        src/backends/javascript/backend.lisp \
        src/backends/javascript/functions.lisp \
        src/backends/javascript/html.lisp \
	$(plump_sources)

build.lisp: build.lisp.in
	$(SED) -e 's|@datadir[@]|$(pkgdatadir)|g' $< > $@

tridashc: build.lisp $(sources)
	$(LISP) --load $(srcdir)/tridash.asd --load $<


# JS Runtime Library

js_runtime_sources = src/backends/javascript/runtime/runtime.js \
	src/backends/javascript/runtime/queue.js \
	src/backends/javascript/runtime/functions.js \
	src/backends/javascript/runtime/exports.js

UGLIFYJS = @UGLIFYJS@

src/backends/javascript/runtime/tridash.min.js: $(js_runtime_sources)
	$(UGLIFYJS) --wrap Tridash -m -o $@ $^

js_runtime: src/backends/javascript/runtime/tridash.min.js


## Documentation

man: doc/tridashc.1

doc/tridashc.1: doc/tridashc.1.adoc
	- $(A2X) --doctype manpage --format manpage --no-xmllint --destination-dir doc $<


## Clean Targets

clean:
	rm -f build.lisp
	rm -f tridashc

distclean: clean
	rm -f Makefile
	rm -f config.log
	rm -f config.status

maintainer-clean: distclean
	rm -f doc/tridashc.1


## Installation Targets

installdirs:
	install -d $(DESTDIR)$(bindir)
	install -d $(DESTDIR)$(pkgdatadir)/modules
	install -d $(DESTDIR)$(pkgdatadir)/backends/javascript
	install -d $(DESTDIR)$(mandir)/man1

install-bin:
	install -m 755 tridashc $(DESTDIR)$(bindir)

install-modules:
	install -m 644 $(srcdir)/modules/core.trd $(srcdir)/modules/core.yml \
		$(DESTDIR)$(pkgdatadir)/modules

install-js-runtime: src/backends/javascript/runtime/tridash.min.js
	install -m 644 $< $(DESTDIR)$(pkgdatadir)/backends/javascript

install-data: install-modules install-js-runtime

install-man:
	- install -m 644 doc/tridashc.1 $(DESTDIR)$(mandir)/man1
	- gzip -f $(DESTDIR)$(mandir)/man1/tridashc.1

install: all installdirs install-bin install-data install-man


uninstall:
	rm -f $(DESTDIR)$(bindir)/tridashc
	rm -rf $(DESTDIR)$(pkgdatadir)
	rm -f $(DESTDIR)$(mandir)/man1/tridashc.1.gz


## Testing

check:
	cd $(srcdir); \
	$(LISP) --load tridash.asd --load test/script.lisp


.PHONY: all man js-runtime clean distclean maintainer-clean \
	install installdirs install-bin install-modules install-data install-man \
	uninstall check
