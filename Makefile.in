## Path to compiler and tools

LISP = @LISP@
SED = @SED@
A2X = @A2X@

## Directories

prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@

datarootdir = @datarootdir@
datadir = @datadir@
mandir = @mandir@

pkgdatadir = @datadir@/@PACKAGE@


PACKAGE_TARNAME = @PACKAGE_TARNAME@
PACKAGE_VERSION = @PACKAGE_VERSION@

# Add source directory to search path for out of source builds

srcdir = @srcdir@
VPATH = $(srcdir)


## Build Targets

all: tridashc man

plump_sources = plump/dom.lisp \
	plump/entities.lisp \
	plump/lexer.lisp \
	plump/package.lisp \
	plump/parser.lisp \
	plump/processing.lisp \
	plump/special-tags.lisp \
	plump/tag-dispatcher.lisp

sources = tridash.asd \
        src/package.lisp \
        src/interface.lisp \
        src/lexer.lisp \
        src/parser.lisp \
        src/operators.lisp \
        src/node.lisp \
        src/meta-node.lisp \
        src/node-table.lisp \
        src/modules.lisp \
        src/conditions.lisp \
        src/outer-nodes.lisp \
        src/builder.lisp \
        src/coalescer.lisp \
        src/prog-builder.lisp \
        src/main.lisp \
        src/util/package.lisp \
        src/util/cut.lisp \
        src/util/macros.lisp \
        src/builders/html/package.lisp \
        src/builders/html/builder.lisp \
        src/backends/javascript/package.lisp \
        src/backends/javascript/ast.lisp \
        src/backends/javascript/print.lisp \
        src/backends/javascript/analyze.lisp \
        src/backends/javascript/backend.lisp \
        src/backends/javascript/functions.lisp \
        src/backends/javascript/html.lisp \
	$(plump_sources)

build.lisp: build.lisp.in
	$(SED) -e 's|@datadir[@]|$(pkgdatadir)|g' $< > $@

tridashc: build.lisp $(sources)
	$(LISP) --load $(srcdir)/tridash.asd --load $<


## Documentation

man: doc/tridashc.1

doc/tridashc.1: doc/tridashc.1.adoc
	$(A2X) --doctype manpage --format manpage --destination-dir doc $<


## Clean Targets

clean:
	rm -f build.lisp
	rm -f tridashc

distclean: clean
	rm -f Makefile
	rm -f config.log
	rm -f config.status

maintainer-clean: distclean
	rm -f doc/tridashc.1


## Installation Targets

installdirs:
	install -d $(DESTDIR)$(bindir)
	install -d $(DESTDIR)$(pkgdatadir)/modules
	install -d $(DESTDIR)$(pkgdatadir)/backends/javascript
	install -d $(DESTDIR)$(mandir)/man1

install: all installdirs
	install -m 755 tridashc $(DESTDIR)$(bindir)
	install -m 644 $(srcdir)/modules/* $(DESTDIR)$(pkgdatadir)/modules
	install -m 644 $(srcdir)/src/backends/javascript/runtime/tridash.js $(DESTDIR)$(pkgdatadir)/backends/javascript
	install -m 644 doc/tridashc.1 $(DESTDIR)$(mandir)/man1
	gzip -f $(DESTDIR)$(mandir)/man1/tridashc.1


uninstall:
	rm -f $(DESTDIR)$(bindir)/tridashc
	rm -rf $(DESTDIR)$(pkgdatadir)
	rm -f $(DESTDIR)$(mandir)/man1/tridashc.1.gz


## Testing

check:
	cd $(srcdir); \
	$(LISP) --load tridash.asd --load test/script.lisp


.PHONY: all man clean distclean maintainer-clean install installdirs uninstall check
