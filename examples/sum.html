

<!DOCTYPE html>
<html>
  <body>
    <div><label>A:<br><input id="__id1"></label></div>
    <div><label>B:<br><input id="__id2"></label></div>
    <p>A + B = <span id="__id0"></span></p>
  </body>
<script>(function(e){function t(){this.contexts={};this.reserve_queue=new h;this.value=null;this.running=false}function r(e,t){this.node=e;this.context_id=t;this.compute=((e,[t])=>t);this.operands=[];this.observers=[]}r.create=function(e,t,n){var i=new r(e,n);i.operands.length=t;i.operands.fill(null,0);return i};r.create_input=function(e,t){return r.create(e,0,t)};r.prototype.add_observer=function(e,t){this.observers.push([e,t]);e.operands[t]=this.node};function n(e,t){this.context=e;this.start=t;this.operands=e.operands.map(e=>e.next_value);this.value=new s(()=>{return e.compute(this.previous_values,this.operands)});this.previous_values=[];this.value_promise=new a;this.path=new a;this.observers=Promise.resolve(true);this.dependencies=[];this.preconditions=null;this.queued=false}n.prototype.queue=function(e){if(!this.queued){e.next_value=this.value_promise.promise;e.reserve_queue.enqueue(this);e.add_update();this.queued=true}};r.prototype.reserve=function(e,t,r,i,u={},s=false){if(!u[this.context_id]){var o=new n(this,e);u[this.context_id]=o;o.operands[t]=s?null:i;o.dependencies[t]=r;this.reserve_hook(o,t,r,true);if(!s){o.observers=this.reserveObservers(e,o.value_promise.promise,o.path.promise,u);o.queue(this.node);return o.path.promise}}else{o=u[this.context_id];o.operands[t]=s?null:i;o.dependencies[t]=r;this.reserve_hook(o,t,r,false);if(!s){if(!this.queued)o.observers=this.reserveObservers(e,o.value_promise.promise,o.path.promise,u);o.queue(this.node);return o.path.promise}}return Promise.resolve(true)};r.prototype.reserve_hook=function(e,t,r,n){};r.prototype.reserveObservers=function(e,t,r,n){return Promise.all(this.observers.map(([i,u])=>i.reserve(e,u,r,t,n)))};t.prototype.add_update=function(){if(!this.running)this.update()};t.prototype.update=function(){this.running=true;var e=this.reserve_queue.dequeue();if(e){var{context:t,start:r,observers:n,value:i}=e;n.then(()=>r).then(()=>{e.path.resolve(true);return Promise.all(e.dependencies)}).then(()=>e.preconditions).then(()=>{var t=Promise.all(e.operands).then(t=>{e.operands=t;this.value=i;this.update_value(i);return i});e.value_promise.resolve(t);return t}).finally(this.update.bind(this))}else{this.running=false}};t.prototype.update_value=function(e){};t.prototype.add_watch=function(e){var t=this.update_value;this.update_value=(r=>{t(r);e(r)})};t.prototype.set_value=function(e){var t=new a;this.contexts["input"].reserve(t.promise,0,null,e);t.resolve(true)};function i(e){var t=new a;var r={};e.forEach(([e,n])=>{e.contexts["input"].reserve(t.promise,0,null,n,r)});t.resolve(true)}function u(e=null,t=0){this.type=e;this.uncatch=t}function s(e,t=null){this.computed=false;this.compute=e;this.fail_handler=t}s.prototype.resolve=function(){if(this.computed){return this.result}else{this.result=this.compute();this.computed=true;return this.result}};function o(e){function t(e,t){this.handler=e;this.next=t}var r=null;while(e instanceof s){if(e.fail_handler){r=new t(e.fail_handler,r)}try{e=e.resolve()}catch(t){if(t instanceof u&&r){e=r.handler(t);r=r.next}else{throw t}}}return e}function a(){this.promise=new Promise((e,t)=>{this.resolve=e;this.reject=t})}function h(){this.head=null;this.tail=null;function e(e){this.elem=e;this.next=null;return this}this.enqueue=function(t){var r=new e(t);if(this.tail){this.tail.next=r;this.tail=r}else{this.head=this.tail=r}return t};this.dequeue=function(){if(this.head){var e=this.head.elem;this.head=this.head.next;if(!this.head)this.tail=null;return e}return null};this.empty=function(){return this.head==null};this.clear=function(){this.head=this.tail=null}}function c(e,t){if(arguments.length<1||arguments.length>2){return $()}try{e=V(o(e));t=o(t);if(t===undefined){return-e}return e-V(t)}catch(e){return new s(()=>{throw e})}}function f(e,t){try{var r=o(e);var n=o(t);if(r instanceof M&&n instanceof M)return r.chr===n.chr;return r===n}catch(e){return new s(()=>{throw e})}}function l(e,t){try{var r=o(e);var n=o(t);if(r instanceof M&&n instanceof M)return r.chr!==n.chr;return r!==n}catch(e){return new s(()=>{throw e})}}function p(e,t){try{return o(e)?t:false}catch(e){return new s(()=>{throw e})}}function d(e,t){try{if(e=o(e))return e;return t}catch(e){return new s(()=>{throw e})}}function v(e){try{return!o(e)}catch(e){return new s(()=>{throw e})}}function w(e=null){return new s(()=>{throw new u(e)})}function y(e){try{o(e)}catch(e){if(e instanceof u)return e.type}return w(W)}function _(e,t,r){r=r||(()=>true);var n=new s(()=>e,e=>{if(e.uncatch===0){return new s(()=>{r=o(r);if(r(e.type))return t;throw e})}return new s(()=>{throw new u(e.type,e.uncatch-1)})});return n}function m(e){return new s(()=>e,e=>{return new s(()=>{throw new u(e.type,e.uncatch+1)})})}function g(e){try{var t=parseInt(o(e));return!isNaN(t)?t:w(Y)}catch(e){return new s(()=>{throw e})}}function b(e){try{var t=parseFloat(o(e));return!isNaN(t)?t:w(Z)}catch(e){return new s(()=>{throw e})}}function x(e){try{e=o(e);if(e instanceof M)return e.chr;else return String(e)}catch(e){return new s(()=>{throw e})}}var q=Number.isInteger||function(e){return typeof e==="number"&&isFinite(e)&&Math.floor(e)===e};function N(e){try{return q(o(e))}catch(e){return new s(()=>{throw e})}}function k(e){try{return typeof o(e)==="number"}catch(e){return new s(()=>{throw e})}}function A(e){try{return typeof o(e)==="string"}catch(e){return new s(()=>{throw e})}}function I(e){try{var t=o(e);return typeof t==="number"&&!isFinite(t)&&!isNaN(t)}catch(e){return new s(()=>{throw e})}}function P(e){try{return isNaN(o(e))}catch(e){return new s(()=>{throw e})}}function T(e,t){return new E(e,t)}function E(e,t){this.head=e;this.tail=t}function F(e,t){this.array=e;this.start=t}function O(e){try{var t=o(e);if(t instanceof E){return t.head}else if(Array.isArray(t)){if(t.length>0)return t[0];return B()}else if(t instanceof F){return t.array.length>t.start?t.array[t.start]:B()}else{return t===null?B():w(W)}}catch(e){return new s(()=>{throw e})}}function j(e){try{var t=o(e);if(t instanceof E){return t.tail}else if(Array.isArray(t)){if(t.length>1)return new F(t,1);return B()}else if(t instanceof F){return t.array.length>t.start+1?new F(t.array,t.start+1):B()}else{return t===null?B():w(W)}}catch(e){return new s(()=>{throw e})}}function C(e){try{var t=o(e);return t instanceof E||t instanceof F&&t.array.length>t.start||Array.isArray(t)&&t.length>0}catch(e){return new s(()=>{throw e})}}function B(){return w(B)}function M(e){this.chr=e}function R(e,t){try{var r=G(o(e));var n=z(o(t));return n>=0&&n<r.length?new M(r.charAt(n)):w(X)}catch(e){return new s(()=>{throw e})}}function S(e,t){try{var r=G(o(e));var n=G(o(t));return r+n}catch(e){return new s(()=>{throw e})}}function V(e){if(typeof e==="number"){return e}throw new u(W)}function z(e){if(q(e)){return e}throw new u(W)}function D(e){if(typeof e==="number"||typeof e==="string"||e instanceof H){return e}throw new u(W)}function G(e){if(typeof e==="string"){return e}throw new u(W)}function H(e){this.name=e}var J={};function K(e){return J[e]||(J[e]=new H(e))}function L(e,t){try{e=o(e);if(typeof e!=="object")return W();t=o(t);return t in e?e[t]:w()}catch(e){return new s(()=>{throw e})}}function Q(e,t){function r(e){res=[];e=n(e);while(e){if(e instanceof E){res.push(e.head);e=n(e.tail)}else if(e instanceof F){res.push(...e.array.slice(e.start));e=null}else if(Array.isArray(e)){res.push(...e);e=null}else{throw new u(W)}}return res}function n(e){try{return o(e)}catch(e){if(e instanceof u&&e.type==B)return null;throw e}}try{e=o(e);if(typeof e!=="function"){return W()}return e.apply(null,r(t))}catch(e){return new s(()=>{throw e})}}function U(){return w(U)}function W(){return w(W)}function X(){return w(X)}function Y(){return w(Y)}function Z(){return w(Z)}function $(){return w($)}e.Node=t;e.NodeContext=r;e.set_values=i;e.Fail=u;e.Thunk=s;e.resolve=o;e.nodes={};e.type_nodes={};e.sub_neg=c;e.eq=f;e.neq=l;e.and=p;e.or=d;e.not=v;e.fail=w;e.fail_type=y;e.make_catch_thunk=_;e.uncatch_thunk=m;e.cast_int=g;e.cast_real=b;e.cast_string=x;e.is_int=N;e.is_real=k;e.is_string=A;e.is_inf=I;e.is_nan=P;e.cons=T;e.head=O;e.tail=j;e.is_cons=C;e.Empty=B;e.Char=M;e.string_at=R;e.string_concat=S;e.check_number=V;e.check_value=D;e.check_string=G;e.get_symbol=K;e.member=L;e.mapply=Q;e.NoValue=U;e.TypeError=W;e.IndexOutBounds=X;e.InvalidInteger=Y;e.InvalidReal=Z;e.ArityError=$})(typeof Tridash=="undefined"?Tridash={}:Tridash);</script><script>(function(){var node0=new Tridash.Node();(function(){var context=Tridash.NodeContext.create(node0,1,0);context.compute=function(previous,values){return {"textContent":values[0]};};node0.contexts[0]=context;})();document.addEventListener("DOMContentLoaded",function(){node0.html_element=(document.getElementById("__id0"));});node0.update_value=function(value){node0.html_element.textContent=(Tridash.resolve(Tridash.resolve(value).textContent));};var node1=new Tridash.Node();(function(){var context=Tridash.NodeContext.create(node1,2,1);context.compute=function(previous,values){return (Tridash.check_number(Tridash.resolve(metanode0(values[0]))))+(Tridash.check_number(Tridash.resolve(metanode0(values[1]))));};node1.contexts[0]=context;})();(function(){var context=Tridash.NodeContext.create_input(node1,2);node1.contexts["input"]=context;})();var node2=new Tridash.Node();(function(){var context=Tridash.NodeContext.create(node2,1,3);context.compute=function(previous,values){return {"value":values[0]};};node2.contexts[0]=context;})();document.addEventListener("DOMContentLoaded",function(){node2.html_element=(document.getElementById("__id1"));});node2.update_value=function(value){node2.html_element.value=(Tridash.resolve(Tridash.resolve(value).value));};var node3=new Tridash.Node();(function(){var context=Tridash.NodeContext.create_input(node3,4);node3.contexts["input"]=context;})();document.addEventListener("DOMContentLoaded",function(){node3.html_element=(document.getElementById("__id1"));node3.value=node3.html_element.value;node3.html_element.addEventListener("change",function(){node3.value=this.value;node3.set_value(node3.value);});});var node4=new Tridash.Node();(function(){var context=Tridash.NodeContext.create(node4,1,5);context.compute=function(previous,values){return {"value":values[0]};};node4.contexts[0]=context;})();document.addEventListener("DOMContentLoaded",function(){node4.html_element=(document.getElementById("__id2"));});node4.update_value=function(value){node4.html_element.value=(Tridash.resolve(Tridash.resolve(value).value));};var node5=new Tridash.Node();(function(){var context=Tridash.NodeContext.create_input(node5,6);node5.contexts["input"]=context;})();document.addEventListener("DOMContentLoaded",function(){node5.html_element=(document.getElementById("__id2"));node5.value=node5.html_element.value;node5.html_element.addEventListener("change",function(){node5.value=this.value;node5.set_value(node5.value);});});function metanode0(a0){return Tridash.cast_int(a0);};node0.contexts[0].reserveObservers=function(start,value,path,visited){return Promise.all([]);};node1.contexts[0].add_observer(node0.contexts[0],0);node1.contexts[0].reserveObservers=function(start,value,path,visited){return Promise.all([node0.contexts[0].reserve(start,0,path,value,visited,false)]);};node1.contexts["input"].add_observer(node0.contexts[0],0);node1.contexts["input"].reserveObservers=function(start,value,path,visited){return Promise.all([node0.contexts[0].reserve(start,0,path,value,visited,false)]);};node2.contexts[0].reserveObservers=function(start,value,path,visited){return Promise.all([]);};node3.contexts["input"].add_observer(node2.contexts[0],0);node3.contexts["input"].add_observer(node1.contexts[0],0);node3.contexts["input"].reserveObservers=function(start,value,path,visited){return Promise.all([node2.contexts[0].reserve(start,0,path,value,visited,false),node1.contexts[0].reserve(start,0,path,value,visited,false)]);};node4.contexts[0].reserveObservers=function(start,value,path,visited){return Promise.all([]);};node5.contexts["input"].add_observer(node4.contexts[0],0);node5.contexts["input"].add_observer(node1.contexts[0],1);node5.contexts["input"].reserveObservers=function(start,value,path,visited){return Promise.all([node4.contexts[0].reserve(start,0,path,value,visited,false),node1.contexts[0].reserve(start,1,path,value,visited,false)]);};})();</script></html>
